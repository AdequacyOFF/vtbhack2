# Мультибанковое приложение

Комплексное мобильное приложение на Flutter для VTB Hack 2025, объединяющее банковские счета из нескольких банков и предоставляющее интеллектуальные финансовые сервисы.

## Основные возможности

### 1. Агрегация счетов из нескольких банков
- Подключение к **3 банкам**: VBank, ABank и SBank
- Отображение всех счетов в едином интерфейсе
- Автоматическое обновление балансов
- История транзакций по каждому счету
- Автоматическая загрузка данных за последние 365 дней

### 2. Умные финансовые продукты

**Умный вклад:**
- Автоматическое сравнение процентных ставок по вкладам во всех банках
- Рекомендация банка с лучшей ставкой
- Возможность ручного выбора банка

**Умный кредит:**
- Сравнение процентных ставок по кредитам во всех банках
- Автоматический выбор банка с самой низкой ставкой
- Поддержка ручного выбора банка

### 3. Универсальная система переводов
- Переводы между любыми счетами (в рамках одного банка или между банками)
- Автоматическое управление согласиями
- Поддержка межбанковских переводов
- Отслеживание статуса платежей в реальном времени

### 4. Умный выбор для оплаты
- Анализ доступных счетов для оплаты
- Выбор счета с максимальным кэшбэком
- Оптимизация маршрутизации платежей

### 5. Персонализированные новости
- Анализ категорий ваших расходов
- Подборка актуальных новостей на основе ваших интересов
- Интеграция с ML-сервисом для персональных рекомендаций
- Автоматическая загрузка при входе в приложение

### 6. Поиск банкоматов
- Интегрированная карта Yandex Maps со всеми банкоматами партнерских банков
- Отображение локаций в реальном времени:
  - Банкоматы VBank
  - Банкоматы ABank
  - Банкоматы SBank

### 7. Генерация выписок по счетам
- Формирование подробных PDF-выписок
- Включение всех счетов и транзакций
- Функция экспорта и отправки

### 8. Экспорт аналитики для ML
- Анализ паттернов транзакций по категориям
- Экспорт данных о частоте транзакций
- Подготовка данных для анализа нейронными сетями
- Разбивка расходов по категориям

### 9. Система уведомлений
- Уведомления о новых транзакциях
- Уведомления об изменении баланса
- Статусы согласий и важные события
- Счетчик непрочитанных уведомлений

### 10. Интеллектуальное управление согласиями
- Автоматическое создание согласий для всех банков
- Обработка авто-подтверждения (VBank, ABank)
- Поддержка ручного подтверждения (SBank)
- Автоматическая проверка статусов каждые 10 секунд
- Постоянное хранение согласий

## Технологический стек

- **Фреймворк**: Flutter 3.9.2
- **Язык**: Dart
- **Управление состоянием**: Provider
- **HTTP-клиент**: http + dio
- **Карты**: Yandex MapKit
- **PDF**: pdf + printing
- **Хранилище**: shared_preferences

## Архитектура

### Паттерн чистой архитектуры
```
lib/
├── config/          # Конфигурация (API endpoints, тема)
├── models/          # Модели данных
│   ├── bank_account.dart
│   ├── transaction.dart
│   ├── product.dart
│   ├── consent.dart
│   ├── bank_token.dart
│   └── news.dart
├── services/        # Бизнес-логика
│   ├── auth_service.dart
│   ├── bank_api_service.dart
│   ├── consent_polling_service.dart
│   ├── notification_service.dart
│   ├── pdf_service.dart
│   ├── news_service.dart
│   └── analytics_service.dart
├── providers/       # Управление состоянием
│   ├── account_provider.dart
│   ├── product_provider.dart
│   ├── transfer_provider.dart
│   └── news_provider.dart
├── screens/         # UI экраны
│   ├── login_screen.dart
│   ├── home_screen.dart
│   ├── accounts_screen.dart
│   ├── products_screen.dart
│   ├── transfer_screen.dart
│   ├── news_screen.dart
│   ├── atm_map_screen.dart
│   ├── notifications_screen.dart
│   ├── consent_management_screen.dart
│   └── profile_screen.dart
└── main.dart        # Точка входа
```

### Ключевые сервисы
- **AuthService**: Аутентификация и управление согласиями
- **BankApiService**: API-клиент для каждого банка
- **ConsentPollingService**: Автоматическая проверка статусов согласий
- **NotificationService**: Система уведомлений
- **PdfService**: Генерация выписок
- **NewsService**: Интеграция с ML-сервисом новостей
- **AnalyticsService**: Анализ транзакций

## Быстрый старт

### Требования
- Flutter SDK 3.9.2 или выше
- Android Studio / VS Code
- Android-устройство или эмулятор

### Установка

1. **Клонирование репозитория**
```bash
git clone <repository-url>
cd vtbhack2
```

2. **Установка зависимостей**
```bash
flutter pub get
```

3. **Настройка API учетных данных**
Отредактируйте `lib/config/api_config.dart` с учетными данными вашей команды:
```dart
static const String clientId = 'team201';
static const String clientSecret = 'YOUR_SECRET';
```

4. **Запуск приложения**
```bash
flutter run
```

### Первый запуск

1. Введите Client ID (например, `team201-10`)
2. Приложение автоматически:
   - Получит токены банков
   - Создаст необходимые согласия
   - Загрузит счета из всех банков
   - Загрузит историю транзакций
   - Сформирует персонализированные новости

## Интеграция с API

### Банковские API
Приложение интегрируется с тремя OpenBanking API:
- **VBank**: https://vbank.open.bankingapi.ru
- **ABank**: https://abank.open.bankingapi.ru
- **SBank**: https://sbank.open.bankingapi.ru

### Последовательность аутентификации
1. Получение токена банка: `POST /auth/bank-token`
2. Создание согласий: `POST /account-consents/request`
3. Получение счетов: `GET /accounts`
4. Получение балансов: `GET /accounts/{id}/balances`
5. Получение транзакций: `GET /accounts/{id}/transactions`

### Ключевые заголовки
- `Authorization`: Bearer токен
- `x-consent-id`: Идентификатор согласия
- `x-requesting-bank`: ID команды
- `x-fapi-interaction-id`: Базовый ID команды (для проверки статуса)

### ML-сервис новостей
```
GET http://host:port/news
Content-Type: application/json

{
  "n": 5,
  "top_spend_categories": ["Путешествия", "Инвестиции", "Технологии"],
  "disliked_titles": ["Как новые пошлины США влияют на экономику Сингапура?", "Зафиксирован рост цен на нефть на 2 п.п. по сравнения с Июнем."]
}
```

Возвращает массив новостных статей с заголовками, описаниями, изображениями в base64 и ссылками.

### ML-сервис распределения бюджета
```
GET http://host:port/advice
Content-Type: application/json

{
  "earnings": 5400,
  "wastes": {
    "rent": 2200,
    "groceries": 650,
    "dining": 400,
    "travel": 250
  },
  "wishes": "Помоги мне сэкономить на мини-отпуск на следующие выходные. Думаю, я мог бы поменьше ходить в кафе и рестораны..."
}
```

Подробнее о работе ML-сервисов в *financial-assistant*

## Статус реализации функций

✅ Агрегация счетов из нескольких банков
✅ Создание умных вкладов
✅ Оформление умных кредитов
✅ Межбанковские переводы
✅ Интеграция карт с банкоматами
✅ Генерация PDF-выписок
✅ Аналитика транзакций для ML
✅ Управление согласиями
✅ Персонализированные новости
✅ Система уведомлений
✅ Автоматическая проверка статусов согласий

## UI дизайн

Приложение выполнено в стиле VTB:
- Основной цвет: VTB Blue (#0028FF)
- Чистый, современный дизайн на основе карточек
- Интуитивная навигация с нижней панелью
- Плавные анимации и переходы

## Экраны

1. **Экран входа**: Ввод Client ID
2. **Главная/Dashboard**: Просмотр всех агрегированных счетов
3. **Детали счета**: Просмотр транзакций по конкретному счету
4. **Продукты**: Просмотр вкладов, кредитов и карт
5. **Переводы**: Отправка денег между счетами
6. **Новости**: Персонализированные новости на основе трат
7. **Карта банкоматов**: Поиск ближайших банкоматов
8. **Уведомления**: Центр уведомлений
9. **Управление согласиями**: Ручное управление согласиями
10. **Профиль**: Экспорт выписок, аналитика, настройки

## Тестирование

```bash
# Запуск всех тестов
flutter test

# Запуск с покрытием кода
flutter test --coverage

# Анализ кода
flutter analyze
```

## Сборка

```bash
# Debug APK
flutter build apk

# Release APK
flutter build apk --release

# App Bundle для Google Play
flutter build appbundle
```

## Особенности реализации

### Композитные ключи для балансов
Приложение использует уникальный формат ключей `bankCode:accountId` для хранения балансов, что предотвращает коллизии между счетами с одинаковыми ID в разных банках.

```dart
Map<String, double> _balances = {
  'vbank:12345': 1000.0,
  'abank:12345': 2000.0,  // Разные счета, несмотря на одинаковые ID
  'sbank:99999': 5000.0,
};
```

### Автоматическая загрузка данных
При входе в систему автоматически загружаются:
1. Счета из всех банков
2. Балансы по каждому счету
3. История транзакций (365 дней)
4. Персонализированные новости на основе категорий трат

### Управление согласиями
Приложение автоматически создает три типа согласий:
- **Account Consent** - доступ к счетам, балансам и транзакциям
- **Payment Consent** - VRP для переводов
- **Product Agreement Consent** - управление продуктами

### Различия между банками
- **VBank & ABank**: Автоматическое подтверждение согласий
- **SBank**: Требуется ручное подтверждение на сайте банка

### Автоматическая проверка статусов
`ConsentPollingService` автоматически проверяет статусы ожидающих согласий:
- Интервал проверки: каждые 10 секунд
- Максимальное время ожидания: 20 минут (120 попыток)
- При подтверждении на сайте банка статус обновляется автоматически

### Статусы согласий
- **Approved/Active/Authorized** - согласие одобрено
- **Pending/AwaitingAuthorization** - ожидает подтверждения
- **Rejected** - отклонено

### Особенности SBank
- Использует `request_id` вместо `consent_id` в ответах
- При подтверждении `consent_id` изменяется с `req-*` на `consent-*`
- Требует заголовок `x-fapi-interaction-id` с базовым ID команды

## Агрегатор новостей

Подмодуль, помогающий создавать персонализированные новости на основе истории транзакций.
Репозиторий: [news-aggregator](https://github.com/AdequacyOFF/news-aggregator.git)

## Известные ограничения

1. Ограничение на 3 партнерских банка
2. Локации банкоматов захардкожены для демонстрации
3. Расчет кэшбэка требует поддержки банковского API

## Устранение неполадок

### Проблема: Согласия не подтверждаются
**Решение**:
- Проверьте правильность формата client_id (например, team201-10)
- Для SBank требуется ручное подтверждение на сайте банка
- Дождитесь автоматического обновления статуса (до 10 секунд)

### Проблема: Счета не загружаются
**Решение**:
- Проверьте интернет-соединение
- Убедитесь, что согласия подтверждены
- Проверьте API endpoints в конфигурации

### Проблема: Карты не отображаются
**Решение**:
- Проверьте API-ключ Yandex Maps
- Убедитесь в наличии разрешений Android на геолокацию

### Проблема: Ошибка генерации PDF
**Решение**:
- Проверьте разрешения на запись в хранилище
- Убедитесь в наличии транзакций для выписки
- Проверьте уровень Android API для Scoped Storage

### Проблема: Новости не загружаются
**Решение**:
- Убедитесь, что есть история транзакций
- Проверьте подключение к ML-сервису
- Проверьте логи на наличие ошибок категоризации

## Лицензия

Этот проект создан для VTB Hack 2025.

## Контакты

По вопросам и проблемам обращайтесь к команде разработчиков.
